#!/usr/bin/env perl
use Git::Crypt;
use Crypt::CBC;
use IO::All;
use JSON::XS;

#Command line gitcrypt utility. This tool should be used inside gitdir containing .gitcrypt config file

#read .gitcrypt config file

#usage:
#   $ gitcrypt
#   Avaliable commands:
#   gitcrypt init
#
#   configuration options:
#   gitcrypt set cipher Blowfish
#   gitcrypt set key    some key
#   gitcrypt set salt   some salt
#
#   managing files
#   gitcrypt list
#   gitcrypt add some/file
#   gitcrypt del some/file
#
#   gitcrypt encrypt
#
#   gitcrypt decrypt
#
#   $ gitcrypt status
#   cipher  Blowfish
#   key     some key
#   salt    some salt
#   Current files status: encrypted
#
#
#   $ gitcrypt list
#   list : dir/file1
#          dir/file2
#          file3
#          dir/sub/file4
#
#   $ gitcrypt add some/file
#   add  : some/file
#
#   $ gitcrypt del some/file
#   del  : some/file
#
#   $ gitcrypt encrypt
#   files encrypted
#
#   $ gitcrypt decrypt
#   files decrypted

my $config_file = $ENV{GITCRYPT_CONFIG_FILE} || '.gitcrypt';

#load config or start with new one
my $config =
    ( -e $config_file )
        ? decode_json io($config_file)->slurp
        : { files => [] };

my $gitcrypt = Git::Crypt->new(
    files       => $config->{ files },
    key         => $config->{ key },
    cipher_name => $config->{ cipher_name }||undef,
    salt        => exists $config->{salt} ?pack( "H16", $config->{ salt } ) : undef,
    key         => $config->{ key }||undef,
    cipher_name => $config->{ cipher_name }||undef,
    salt        => $config->{ salt }||undef,
);

#get current action
my $action = $ARGV[0]||undef;
   if (!@ARGV)               { show_commands(); }
elsif ( $action eq 'init' )    { init() } 
elsif ( $action eq 'set' )     { set() } 
elsif ( $action eq 'list' )    { list() }
elsif ( $action eq 'add' )     { add() }
elsif ( $action eq 'del' )     { del() } 
elsif ( $action eq 'encrypt' ) { encrypt() } 
elsif ( $action eq 'decrypt' ) { decrypt() } 
elsif ( $action eq 'status' )  { status() }
else  { print "Command not avaliable\n"; }

sub show_commands {
    print <<COMMANDS;
Avaliable commands:
    gitcrypt init

Configuration options:
    gitcrypt set cipher Blowfish
    gitcrypt set key    some key
    gitcrypt set salt   some salt

Managing files:
    gitcrypt list
    gitcrypt add some/file1 other/file
    gitcrypt del some/file1 file2

Encrypt files:
    gitcrypt encrypt

Decrypt files:
    gitcrypt decrypt
COMMANDS
}

sub status {
    print "cipher   $gitcrypt->cipher_name"  if defined $gitcrypt->cipher_name;
    print "\n";
    print "key      $gitcrypt->key"     if defined $gitcrypt->key;
    print "\n";
    print "salt     $gitcrypt->salt"    if defined $gitcrypt->salt;
    print "\n\n";
    list();
}

sub init {
    if ( ! -e $config_file ) {
        print "Initializing $config_file";
        print <<STEPS;
Now configure your cipher, key and salt:
    gitcrypt set cipher Blowfish
    gitcrypt set key    some key
    gitcrypt set salt   some salt

STEPS
        save_config();
    } else {
        print "You already initialized an $config_file\n";
    }
}

sub validate {
    return 1
        if      defined $gitcrypt->cipher_name
            and defined $gitcrypt->salt
            and defined $gitcrypt->key
            ;
    print <<HELP;
You must set the cipher, salt and key. 
Use gitcrypt status and see current configuration.
HELP
    return 0;
}

sub encrypt {
    return if ! validate();
    $gitcrypt->encrypt;
    save_config();
    print "Encrypted.";
}

sub decrypt {
    return if ! validate();
    $gitcrypt->decrypt;
    save_config();
    print "Decrypted.";
}

sub del {
    if ( ! $ARGV[1] ) {
        print <<HELP;
You must supply one or more files to be deleted. 
ie: gitcrypt del file1 dir/file2
HELP
    } else {
        shift @ARGV;
        print "Deleting files:\n";
        $gitcrypt->del( \@ARGV );
        save_config();
    }
}

sub add {
    if ( ! $ARGV[1] ) {
        print <<HELP;
You must supply one or more files to be added. 
ie: gitcrypt add file1 dir/file2\n"; 
HELP
    } else {
        shift @ARGV;
        print "Adding files: \n";
        $gitcrypt->add( \@ARGV );
        save_config();
    }
}

sub list {
    #print files from $config
    if ( ! $config->{ files } || scalar @{ $config->{ files } } == 0 ) {
        print "No files added\n";
        return;
    }
    print "Files added:\n";
    print "File         Status:\n";
    for ( @{ $gitcrypt->files } ) {
        print $_->{file} . "   " . $_->{is_encrypted} , "\n";
    }
}

sub set {
    if ( $ARGV[1] eq 'cipher' ) {
        set_cipher();
    } elsif ( $ARGV[1] eq 'key' ) {
        set_key();
    } elsif ( $ARGV[1] eq 'salt' ) {
        set_salt();
    } else {
        print "incorrect option $ARGV[1]\n";
    }
}

sub set_cipher {
    #set cipher
    if ( ! $ARGV[2] ) { 
        print "You must set a cipher. ie: Blowfish \n";
        return;
    }
    shift @ARGV;    #set
    shift @ARGV;    #cipher
    $gitcrypt->cipher_name( join " ", @ARGV );
    print "Set cipher to: ",$gitcrypt->cipher_name,"\n";
    save_config();
}

sub set_key {
    #set key
    if ( ! $ARGV[2] ) {
        print "You did not pass a key\n";
        return
    }
    shift @ARGV;    #set
    shift @ARGV;    #key
    $gitcrypt->key(join " ", @ARGV);
    print "Set key to: ",$gitcrypt->key,"\n";
    save_config();
}

sub set_salt {
    #set salt
    if ( ! $ARGV[2] ) {
        print "You did not pass a salt\n";
        return
    }
    shift @ARGV;    #set
    shift @ARGV;    #salt
    $gitcrypt->salt( join " ", @ARGV );
    print "Set salt to: ",$gitcrypt->salt,"\n";
    save_config();
}

sub save_config {
    io( $config_file )->print( encode_json $gitcrypt->config );
}


